<template>
  <q-page>
    <div class="q-pa-md">
      <q-card bordered class="bg-secondary text-white">
        <q-card-section>
          <div class="text-h6">ë‚™ì›ì´ë€?</div>

          <div class="text-subtitle2">
            ì¼í•˜ì§€ ì•Šê³ ë„ ì›í•˜ëŠ” ìƒí™œì„ í•  ìˆ˜ ìˆëŠ” ì¬ì • ìƒíƒœë¥¼ ë§í•©ë‹ˆë‹¤.
            <br />ì˜ˆë¥¼ë“¤ì–´, ì›í•˜ëŠ” ìƒí™œ ìˆ˜ì¤€(ì›” 500ë§Œì›)ì„ í•˜ê¸° ìœ„í•œ ìƒí™œë¹„ê°€
            ìë³¸ì†Œë“ìœ¼ë¡œ íšë“ì´ ê°€ëŠ¥ í• ë•Œ(ì›” 500ë§Œì›)ì´ ë“¤ì–´ì˜¨ë‹¤ë©´
            ë‚™ì›(Paradise) ìƒíƒœ ì…ë‹ˆë‹¤. (í˜¹ì€ ê²½ì œì ììœ  ìƒíƒœ)
            <br />
          </div>
        </q-card-section>
      </q-card>
    </div>

    <div class="q-pa-md">
      <h4 class="q-my-md">ë‹¹ì‹ ì˜ ìì‚° ëª©í‘œ ê¸ˆì•¡ì€?</h4>
      <p>
        í˜„ì¬ì˜ ìì‚°ê³¼ ì €ì¶•ê¸ˆì•¡ì„ ì…ë ¥í•´ì„œ ì€í‡´ì‹œì ì˜ ìì‚°ì´ ì–´ëŠì •ë„ ìˆ˜ì¤€ì¸ì§€
        ê³„ì‚°í•´ë³´ì„¸ìš”.
        <br />ê·¸ë¦¬ê³  ìì‚°/ì €ì¶•/ì€í‡´ì‹œì /ìˆ˜ìµìœ¨ì„ ìˆ˜ì¹˜ë¥¼ ì¡°ì ˆ í•˜ë©´ì„œ ì¬ì •
        ëª©í‘œì¹˜ë¥¼ ì •í•´ë³´ì„¸ìš”.
      </p>

      <div class="q-gutter-sm">
        <q-btn
          color="white"
          text-color="blue"
          label="ìì‚°:2ì–µ ì €ì¶•:1200 ì€í‡´:10ë…„í›„ ìˆ˜ìµ:10% ì˜ˆì œ"
          icon-right="open_in_new"
          style="border:1px solid #027be3;"
          @click="showExample"
        ></q-btn>

        <q-btn
          color="primary"
          label="ë‚™ì› ì„¤ë¬¸ ì°¸ì—¬í•˜ê¸° ğŸ˜˜"
          icon-right="open_in_new"
          @click="moveSurvey()"
        ></q-btn>
      </div>

      <div class="row q-col-gutter-xs">
        <div class="col-6 col-xl-2 input-short-won">
          <q-input
            :value="assets"
            label="ë³´ìœ  ìì‚°"
            stack-label
            :dense="dense"
            suffix="ë§Œì›"
            placeholder="ì€í‡´ê¸°ê°„ ë™ì•ˆ ìë³¸ì†Œë“ì„ ë°œìƒ ì‹œí‚¤ëŠ” ìì‚° ê¸ˆì•¡ì…ë‹ˆë‹¤"
            @input="changeAssets"
          >
            <q-tooltip>í˜„ì¬ ìì‚°ì„ ë§Œì› ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</q-tooltip>
          </q-input>
        </div>

        <div class="col-6 col-xl-2 input-short-won">
          <q-input
            :value="yearSavingAmount"
            label="ì €ì¶•ê¸ˆì•¡(ì—°)"
            stack-label
            :dense="dense"
            suffix="ë§Œì›"
            placeholder="í•œí•´ ë™ì•ˆ ì €ì¶• ê°€ëŠ¥í•œ ê¸ˆì•¡ì…ë‹ˆë‹¤"
            @input="changeYearSavingAmount"
          >
            <q-tooltip
              >í•œí•´ ë™ì•ˆ ì €ì¶• ê°€ëŠ¥í•œ ê¸ˆì•¡ì„ ë§Œì› ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.</q-tooltip
            >
          </q-input>
        </div>

        <div class="col-4 input-short-won">
          <q-input
            :value="termsOfRetire"
            label="ì€í‡´ì‹œê¸°"
            stack-label
            :dense="dense"
            suffix="ë…„ í›„"
            placeholder="ì€í‡´ê¹Œì§€ ë‚¨ì€ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
            @input="changeTermsOfRetire"
          >
            <q-tooltip>ì€í‡´ê¹Œì§€ ë‚¨ì€ ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</q-tooltip>
          </q-input>
        </div>
        <div class="col-4">
          <q-input
            :value="interest"
            label="ëª…ëª© ìˆ˜ìµìœ¨"
            stack-label
            :dense="dense"
            suffix="%"
            placeholder="ëª©í‘œ ëª…ëª©ìˆ˜ìµìœ¨ (ìˆ«ìë§Œ ì…ë ¥)"
            @input="changeInterest"
          >
            <q-tooltip>
              ëª…ëª© ìˆ˜ìµìœ¨ì€ ì¸í”Œë ˆì´ì…˜ì„ ê³ ë ¤í•˜ì§€ ì•Šì€ ì¼ë°˜ì ìœ¼ë¡œ ìš°ë¦¬ ëˆˆì—
              ë³´ì´ëŠ” ìˆ˜ìµìœ¨ì…ë‹ˆë‹¤.
            </q-tooltip>
          </q-input>
        </div>
        <div class="col-4">
          <q-input
            :value="inflation"
            label="ì €ì¶• ì¦ê°€ìœ¨"
            stack-label
            :dense="dense"
            suffix="%"
            placeholder="ì‹¤ì§ˆ ì €ì¶•ê¸ˆì•¡ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ ë¹„ìœ¨(=ì¸í”Œë ˆì´ì…˜)"
            @input="changeInflation"
          >
            <q-tooltip>
              ì˜ˆìƒ ì¸í”Œë ˆì´ì…˜ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. ì €ì¶•ê¸ˆì•¡ì„ ë§¤ë…„ ì¸í”Œë ˆì´ì…˜ ë§Œí¼
              ì¶”ê°€ë¡œ ì €ì¶• í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤. (2~3%)
            </q-tooltip>
          </q-input>
        </div>
      </div>

      <q-separator spaced></q-separator>

      <div class="row q-col-gutter-xs">
        <div class="col-6 col-md-4">
          <q-field
            bg-color="cyan-1"
            :label="`ì€í‡´ í›„ ìì‚°`"
            stack-label
            hint="ìì‚° * ìˆ˜ìµìœ¨^ì€í‡´ì‹œê¸° + ì €ì¶•ê¸ˆì•¡ * (ìˆ˜ìµìœ¨ ^ ì€í‡´ì‹œê¸° - ì €ì¶•ì¦ê°€ìœ¨ ^ ì€í‡´ì‹œê¸°) / (ì‹¤ì§ˆìˆ˜ìµìœ¨)"
          >
            <template v-slot:control>
              <div class="self-center full-width no-outline" tabindex="0">
                {{
                  totalAssets
                    | formatMultipleUnitFrom10TTo100M
                    | perThousand(true)
                }}
              </div>
            </template>
            <q-tooltip
              >{{ termsOfRetire || "X" }} ë…„ í›„ì— ëª¨ì•„ì§€ëŠ” ëˆì…ë‹ˆë‹¤.</q-tooltip
            >
          </q-field>
        </div>

        <div class="col-6 col-md-4">
          <q-field
            bg-color="cyan-1"
            :label="`ì€í‡´ í›„ ì›” ìˆ˜ì…`"
            stack-label
            hint="ì€í‡´ í›„ ìì‚°ê³¼ ì‹¤ì§ˆ ìˆ˜ìµìœ¨ë¡œ ë²Œì–´ë“¤ì´ëŠ” ì›” ìˆ˜ì…"
          >
            <template v-slot:control>
              <div class="self-center full-width no-outline" tabindex="0">
                <span v-if="totalAssets > 0 && foundMonthlySpend > 0">
                  {{ foundMonthlySpend | format10Thousand | perThousandFloor }}
                  ë§Œì› /
                  {{ foundInterest }} % (ëª…ëª©:{{
                    addNumber(foundInterest, inflation)
                  }}%)
                </span>
              </div>
            </template>
            <q-tooltip>
              ëª¨ì•„ì§€ëŠ” ëˆê³¼ ê°€ì¥ ê·¼ì‚¬í•œ ë‚™ì›ê¸ˆì•¡ì„ ë§Œë“¤ê¸° ìœ„í•œ ì›”ê¸ˆì•¡ê³¼ ì‹¤ì§ˆ
              ì‹¤ì§ˆ ìˆ˜ìµìœ¨ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
            </q-tooltip>
          </q-field>
        </div>
      </div>
    </div>

    <div class="q-pa-md">
      <h4 class="q-my-md">ë‹¹ì‹ ì˜ ë‚™ì› ê¸ˆì•¡ì€?</h4>
      <div class="text-subtitle1">
        ì›í•˜ëŠ” ë‚™ì›ê¸ˆì•¡(ì›” ì†Œë¹„ì•¡)ì„ ì„ íƒí•´ë³´ì„¸ìš”. ë‚™ì›ì„ ì´ë£¨ê¸° ìœ„í•œ ìì‚°ì„
        ì•Œìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
      <div class="text-body text-grey">
        Tip. ë‚™ì›ê¸ˆì•¡ ê³„ì‚°ì„ ìœ„í•´ì„  ìì‚° ëª©í‘œ ê¸ˆì•¡ ë¶€ë¶„ì˜ ìˆ˜ìµìœ¨/ì€í‡´ì‹œê¸°/ì €ì¶•
        ì¦ê°ìœ¨(ì¸í”Œë ˆ)ë¥¼ ì…ë ¥ í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.
        <br />
        Tip. ì›” ì†Œë¹„ê¸ˆì•¡ê³¼ ìˆ˜ìµìœ¨ì— ë”°ë¼ì„œ ë‚™ì› ê¸ˆì•¡ì´ ì–´ë–»ê²Œ ì°¨ì´ ë‚˜ëŠ”ì§€ í™•ì¸
        í•´ë³´ì„¸ìš”.
        <br />
        Tip. ì€í‡´ í›„ ìì‚°ì„ ê³„ì‚° í•˜ì‹œë©´ ë‚™ì›ì„ ì´ë£¨ê¸° ìœ„í•œ ìì‚°ê³¼ ì€í‡´ í›„ ìì‚°ì˜
        ì°¨ì´ë¥¼ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>

      <div class="row q-col-gutter-xs">
        <div class="col-6 col-md-4">
          <q-select
            filled
            :value="monthlySpend"
            :options="monthlySpends"
            label="ì›” ì†Œë¹„ì•¡"
            stack-label
            :dense="dense"
            :options-dense="denseOpts"
            @input="changeMonthlySpend"
            hint="í˜„ì¬ê°€ì¹˜ ê¸°ì¤€"
          >
            <template v-slot:option="scope">
              <q-item v-bind="scope.itemProps" v-on="scope.itemEvents">
                <q-item-section>
                  <q-item-label caption>
                    {{ scope.opt | format10Thousand | perThousand }}
                    ë§Œì›
                  </q-item-label>
                </q-item-section>
              </q-item>
            </template>

            <template v-slot:selected>
              <span v-if="monthlySpend"
                >{{ monthlySpend | format10Thousand | perThousand }} ë§Œì›</span
              >
              <span v-else></span>
            </template>
          </q-select>
        </div>

        <div class="col-6 col-md-4">
          <q-field
            label="ë‚™ì› ê¸ˆì•¡"
            stack-label
            hint="ì—°ë³µë¦¬ ì‹¤ì§ˆ ìˆ˜ìµìœ¨, í˜„ì¬ ê°€ì¹˜ì˜ ì›” ê¸ˆì•¡"
            bg-color="green-1"
          >
            <template v-slot:control>
              <div class="self-center full-width no-outline" tabindex="0">
                <span v-if="paradiseAmount > 0">
                  {{ termsOfRetire }}ë…„í›„
                  {{
                    paradiseAmount
                      | formatMultipleUnitFrom10TTo100M
                      | perThousand(true)
                  }}/ì—°{{ addNumber(interest, -inflation) }}%ë¡œ ì›”{{
                    monthlySpend | format10Thousand | perThousand
                  }}ë§Œì› Paradise!
                </span>
              </div>
            </template>
            <q-tooltip>
              {{ termsOfRetire }}ë…„ í›„ì— ìˆ˜ìµìœ¨{{ interest }}%ë¡œ ì›” ì†Œë¹„ì•¡({{
                monthlySpend | format10Thousand | perThousand
              }}ë§Œì›. ({{ termsOfRetire }}ë…„ ì¸í”Œë ˆ í¬í•¨ =
              {{ monthlySpend * Math.pow(1 + interest, termsOfRetire) }}ë§Œì›)ì„
              í‰ìƒ~ ì“¸ ìˆ˜ ìˆëŠ” ë‚™ì›ì„ ì´ë£°ìˆ˜ ìˆëŠ” ê¸ˆì•¡ì…ë‹ˆë‹¤.
            </q-tooltip>
          </q-field>
        </div>

        <div class="col-6 col-md-4">
          <q-field
            label="ë‚™ì›ê¹Œì§€ ë‚¨ì€ê¸ˆì•¡"
            :bg-color="paradiseStateColor()"
            stack-label
            hint="[ë‚™ì›ê¸ˆì•¡ - ì€í‡´ í›„ ìì‚°]ìœ¼ë¡œ ë‚™ì›ê¸ˆì•¡ê³¼ì˜ ì°¨ì´"
          >
            <template v-slot:control>
              <div class="self-center full-width no-outline" tabindex="0">
                <span v-if="paradiseAmount > 0 && totalAssets > 0">
                  {{
                    addNumber(paradiseAmount, -totalAssets)
                      | formatMultipleUnitFrom10TTo100M
                      | perThousand
                  }}
                </span>
              </div>
            </template>
            <q-tooltip>
              ì…ë ¥í•˜ì‹  ìì‚°ê³¼ ì €ì¶•ì•¡, ìˆ˜ìµìœ¨ë¡œ ì‚°ì¶œëœ ëª¨ì„ìˆ˜ ìˆëŠ” ëˆê³¼ ë‚™ì›
              ê¸ˆì•¡ê³¼ì˜ ì°¨ì´ ì…ë‹ˆë‹¤. (ìŒìˆ˜ëŠ” ë‚™ì›ê¸ˆì•¡ì„ ì´ˆê³¼)
            </q-tooltip>
          </q-field>
        </div>
      </div>
    </div>

    <div class="q-pa-md">
      <q-table
        title="ë‚™ì› í…Œì´ë¸”"
        :data="paradise_data"
        :columns="paradise_columns"
        row-key="name"
        :pagination="{ rowsPerPage: 40 }"
      >
        <template v-slot:body-cell="scope">
          <q-td :class="scope.row[scope.col.field + '_color']">{{
            scope.value
          }}</q-td>
        </template>

        <template v-slot:bottom>
          <div>
            ** ì›” ê¸ˆì•¡: í˜„ì¬ ê°€ì¹˜, ìˆ˜ìµìœ¨: ì‹¤ì§ˆ ìˆ˜ìµìœ¨,
          </div>
          <div>
            ë‚™ì›ê¸ˆì•¡ ê³„ì‚°ì‹: (ì›” ê¸ˆì•¡ * 12 * (1+ì¸í”Œë ˆì´ì…˜) ^ ì€í‡´ì‹œê¸°) / ì‹¤ì§ˆ
            ìˆ˜ìµìœ¨
          </div>
        </template>
      </q-table>
    </div>

    <div class="q-pa-md">
      <q-card dark bordered class="bg-grey-9 my-card">
        <q-card-section>
          <div class="text-h6">ì–´ë–»ê²Œ ë§Œë“¤ê²Œ ë˜ì—ˆë‚˜?</div>
        </q-card-section>

        <q-separator dark inset />
        <q-card-section>
          í•  ìˆ˜ ìˆë‹¤! ì•Œê³  íˆ¬ì(Kangcfa) ì±„ë„ì˜ 'íˆ¬ìëŠ” ì„ íƒì´ ì•„ë‹ˆë¼
          ìƒì¡´ì´ë‹¤!'ì—ì„œ ì˜ê°ì„ ì–»ì–´ ì‘ì„± í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ìì‚°ì ì¸ ëª©í‘œ ê¸°ì¤€ì„
          ì¡ì„ë•Œ ë„ì›€ì´ ë  ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì´ ë“­ë‹ˆë‹¤.
        </q-card-section>

        <q-card-section>
          <div class="row q-col-gutter-xs">
            <div
              class="col-6 col-xs-12 col-sm-12 col-md-6"
              style="position: relative;height: 0;padding-bottom: 50.25%;"
            >
              <iframe
                src="https://www.youtube.com/embed/-CKWF_PTQNg"
                frameborder="0"
                allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                style="position: absolute; width:100%; height:100%;"
              ></iframe>
            </div>

            <div
              class="col-6 col-xs-12 col-sm-12 col-md-6"
              style="position: relative;height: 0;padding-bottom: 50.25%;"
            >
              <iframe
                src="https://www.youtube.com/embed/XxoEzDS1Mpw"
                frameborder="0"
                allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                style="position: absolute; width:100%; height:100%;"
              ></iframe>
            </div>
          </div>
        </q-card-section>
      </q-card>
    </div>

    <q-dialog v-model="sample" :maximized="false" >
      <q-card>
        <q-card-section>
          <div class="text-h8 text-red">
            ìì‚°ì€ 2ì–µ, ì›” 100ë§Œì›ì”© ì €ì¶•(ë…„ 1,200ë§Œì›), ì€í‡´ì‹œê¸°ëŠ” 10ë…„í›„, ëª…ëª©
            ìˆ˜ìµìœ¨ì€ 10%, ì›” ì†Œë¹„ì•¡ 500ë§Œì› ì˜ˆì œ ì…ë‹ˆë‹¤.
          </div>
        </q-card-section>

        <q-card-actions align="right">
          <q-btn
            flat
            color="primary"
            @click="
              sample = false;
              useDefault();
            "
            >ì‚¬ìš©í•˜ê¸°</q-btn
          >
          <q-btn color="primary" v-close-popup>ë‹«ê¸°</q-btn>
        </q-card-actions>
        <!-- <q-img src="statics/sample.png" height="70%" /> -->
        <img src="statics/sample.png" />
      </q-card>
    </q-dialog>

    <q-dialog v-model="survey" :maximized="false" persistent>
      <q-card >
        <q-card-section>
          <div style="display:flex;justify-content:center;margin:10px 0 20px 0;">
            <img src="statics/please-icon.svg"/>
          </div>

          <div class="text-h6" style="text-align:center;font-size:20px;line-height:26px;">
            ì•—, ì ì‹œë§Œ ì‹œê°„ì„ <br>
            ë‚´ì–´ì£¼ì‹¤ ìˆ˜ ìˆìœ¼ì‹¤ê¹Œìš”?
          </div>
          <br>
          <div style="text-align:center;font-size:14px;min-width:300px;line-height:22px;color:#6f6f6f">
            ë‚™ì›íŒ€ì—ì„œ ì—¬ëŸ¬ë¶„ë“¤ì˜ ê²½ì œì  ììœ ë¥¼ ì§€ì›í•˜ê³  <br>
            ì¡°ê¸ˆ ë” ë‚˜ì€ ì¬í…Œí¬ ì •ë³´ë¥¼ ì•Œë ¤ë“œë¦¬ê³ ì <br>
            ì‘ì€ ì„¤ë¬¸ì„ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤. <br>
            ë°”ì˜ì‹œê² ì§€ë§Œ ì¡°ê¸ˆ ë” ë°œì „ëœ ëª¨ìŠµì„ <br>
            ë³´ì—¬ë“œë¦´ ìˆ˜ ìˆë„ë¡ ì˜ê²¬ ë¶€íƒë“œë¦´ê²Œìš”.
          </div>
        </q-card-section>

          <q-btn-group spread>
            <q-btn flat size="xl" v-close-popup style="background-color:#989ea4;color:#fff;font-size:16px;padding:10px 16px">ë‹¤ìŒì— í• ê²Œìš”..</q-btn>
            <q-btn
              color="primary"
              size="xl" 
              @click="
                survey = false;
                moveSurvey();
              "
              style="font-size:16px;padding:10px 16px"
              >ì§€ê¸ˆ ì°¸ì—¬í•˜ê¸°</q-btn
            >
          </q-btn-group>
      </q-card>
    </q-dialog>
  </q-page>
</template>

<style>
.input-short-won .q-field__suffix {
  width: 45px;
}
</style>

<script>
import numeral from "numeral";
import _ from "lodash";

export default {
  name: "ParadiseCalculatorMain",
  data() {
    return {
      // ë§Œë‹¨ìœ„
      assets: "",
      // ì´ì
      interest: "",
      // ë§Œë‹¨ìœ„
      yearSavingAmount: "",
      inflation: 3,
      termsOfRetire: "",
      dense: false,
      denseOpts: false,

      monthlySpends: [],
      monthlySpend: "",
      paradiseAmount: "",
      paradise_data: [],
      paradise_columns: [
        {
          name: "monthlySpend",
          required: true,
          label: "ì›” ê¸ˆì•¡",
          align: "center",
          field: "monthlySpend",
          format: val => `ì›” ${this.format10ThousandUnitNumber(val)}`,
          sortable: false
        }
      ],
      foundMonthlySpend: "",
      foundInterest: "",
      // sample popup flag
      sample: false,
      survey: false,
      wasShownSurvey: false,
      maximized: false
    };
  },
  mounted() {
    numeral.nullFormat("");

    window.gtag('event', 'page_view', {
      page_title: this.$route.name,
      page_location: this.$route.name,
      page_path: this.$route.path
    });

    this.assets = this.formatNumber(this.assets);
    this.yearSavingAmount = this.formatNumber(this.yearSavingAmount);
    this.interest = this.formatNumber(this.interest);
    this.inflation = this.formatNumber(this.inflation);
    this.termsOfRetire = this.formatNumber(this.termsOfRetire);

    this.monthlySpends.push(...this.createMonthlySpends());

    this.createParadiseColumns();
    this.initParadaiseDatas();
  },
  watch: {
    monthlySpend() {
      if (this.inflation > 0 && this.interest > 0 && this.termsOfRetire > 0) {
        this.paradiseAmount = this.calculateParadiseAmount();
        this.initParadaiseDatas();
      }
    },
    assets() {
      if (this.isReadyCalculation) {
        this.initParadaiseDatas();
      }
    },
    yearSavingAmount() {
      if (this.isReadyCalculation) {
        this.initParadaiseDatas();
      }
    },
    inflation() {
      if (this.isReadyCalculation) {
        this.paradiseAmount = this.calculateParadiseAmount();
        this.initParadaiseDatas();
      }
    },
    interest(newInterest) {
      if (
        this._isReadyCalculation({
          assets: this.assets,
          yearSavingAmount: this.yearSavingAmount,
          interest: newInterest,
          termsOfRetire: this.termsOfRetire
        })
      ) {
        this.paradiseAmount = this.calculateParadiseAmount();
        this.initParadaiseDatas();
      }
    },
    termsOfRetire(newTermsOfRetire) {
      if (
        this._isReadyCalculation({
          assets: this.assets,
          yearSavingAmount: this.yearSavingAmount,
          interest: this.interest,
          termsOfRetire: newTermsOfRetire
        })
      ) {
        this.paradiseAmount = this.calculateParadiseAmount();
        this.initParadaiseDatas();
      }
    }
  },
  computed: {
    isReadyCalculation() {
      return this._isReadyCalculation({
        assets: this.assets,
        yearSavingAmount: this.yearSavingAmount,
        interest: this.interest,
        termsOfRetire: this.termsOfRetire
      });
    },
    totalAssets() {
      if (
        (this.assets <= 0 && this.yearSavingAmount <= 0) ||
        this.termsOfRetire <= 0
      ) {
        return "";
      }

      let assets = numeral(this.assets || 0)
        .multiply(10000)
        .value();
      let yearSavingAmount = numeral(this.yearSavingAmount || 0)
        .multiply(10000)
        .value();
      let interest = numeral(this.interest || 0).value();
      let termsOfRetire = numeral(this.termsOfRetire || 0).value();

      let inflation = numeral(this.inflation || 0).value();

      let calAssets = assets * Math.pow(1 + interest / 100, termsOfRetire);

      // let actualInterest = this.addNumber(interest, -inflation) / 100;
      let actualInterest = (interest - inflation) / 100;
      if (actualInterest === 0) {
        actualInterest = 1;
      }

      let actualInterstPow =
        Math.pow(1 + interest / 100, termsOfRetire) -
        Math.pow(1 + inflation / 100, termsOfRetire);

      const calYearSavingAmount =
        (yearSavingAmount * actualInterstPow) / actualInterest;

      const totalAssets = (calAssets + calYearSavingAmount).toFixed(2);

      this.sendGATotalAssets(totalAssets);
      return totalAssets;
    }
  },
  methods: {
    _isReadyCalculation({ assets, yearSavingAmount, interest, termsOfRetire }) {
      return (
        (numeral(assets).value() > 0 ||
          numeral(yearSavingAmount).value() > 0) &&
        numeral(interest).value() > 0 &&
        numeral(termsOfRetire).value() > 0
      );
    },
    initParadaiseDatas: _.debounce(function() {
      this.paradise_data.splice(0, this.paradise_data.length);
      this.paradise_data.push(...this.calculateParadiseDatas());
      this.findNearParadiseValue();
      this.showSurveyPopupWhenCalculated();
    }, 0),

    changeAssets(value) {
      this.assets = this.formatNumber(value);

      this.sendGAInputAssets(value);
    },

    changeYearSavingAmount(value) {
      // this.yearSavingAmount = this.formatNumber(value)
      this.yearSavingAmount = numeral(value).format("0,0");
      // this.sendGAYearSavingAmount(value);
    },

    changeInterest(value) {
      this.interest = this.formatNumber(value);
      this.sendGAInterest(value);
    },

    changeInflation(value) {
      this.inflation = this.formatNumber(value);
      this.sendGAInflation(value);
    },

    changeTermsOfRetire(value) {
      this.termsOfRetire = this.formatNumber(value);
      this.sendGATermsOfRetire(value);
    },

    changeMonthlySpend(value) {
      this.monthlySpend = value;
      this.sendGAMonthlySpend(value);
    },

    sendGAInputAssets: _.debounce(function(value) {
      window.gtag("event", "input", {
        event_category: "ìì‚°",
        event_label: value ? value.replace(/,/g, "") : value
      });
    }, 5000),

    sendGAYearSavingAmount: _.debounce(function(value) {
      window.gtag("event", "input", {
        event_category: "ì—°ì €ì¶•",
        event_label: value
      });
    }, 5000),

    sendGAInterest: _.debounce(function(value) {
      window.gtag("event", "input", {
        event_category: "ìˆ˜ìµìœ¨",
        event_label: value
      });
    }, 5000),

    sendGAInflation: _.debounce(function(value) {
      window.gtag("event", "input", {
        event_category: "ì¸í”Œë ˆì´ì…˜",
        event_label: value
      });
    }, 5000),

    sendGATermsOfRetire: _.debounce(function(value) {
      window.gtag("event", "input", {
        event_category: "ê¸°ê°„",
        event_label: value
      });
    }, 5000),

    sendGAMonthlySpend: _.debounce(function(value) {
      window.gtag("event", "select", {
        event_category: "ì›”ì†Œë¹„ê¸ˆì•¡",
        event_label: value
      });
    }, 2000),

    sendGATotalAssets: _.debounce(function(value) {
      let amountByUnit = this.amountClassfication(value, 100000000);
      window.gtag("event", "calculate", {
        event_category: "ì€í‡´ ì´ìì‚°",
        event_label: amountByUnit ? `${amountByUnit} ì–µ` : amountByUnit
      });
    }, 2000),

    sendGACalculatedMonthlySpend: _.debounce(function(value) {
      let amountByUnit = this.amountClassfication(value, 1000000);

      window.gtag("event", "calculate", {
        event_category: "ì€í‡´ ì›”ì†Œë¹„",
        event_label: amountByUnit ? `${amountByUnit} ë°±ë§Œ` : amountByUnit
      });
    }, 2000),

    amountClassfication(value, unit) {
      if (isNaN(value)) {
        return value;
      }

      let amountByUnit = (value / unit).toFixed(1);
      if (amountByUnit > 10 && amountByUnit < 100) {
        amountByUnit = Math.floor(amountByUnit / 5) * 5;
      } else if (amountByUnit > 100) {
        amountByUnit = Math.floor(amountByUnit / 100) * 100;
      }

      return amountByUnit;
    },
    inputNumberHandler(target) {
      target.value = numeral(target.value).format("0,0");
    },

    inputAmount10ThousandUnitHandler(target) {
      target.value = this.format10ThousandUnitNumber(target.value);
    },

    format10ThousandUnitNumber(value) {
      return this.formatNumber(numeral(value).value() / 10000);
    },

    formatNumber(value) {
      numeral.nullFormat("");
      return numeral(value).format("0,0");
    },

    createMonthlySpends() {
      var rangeValues = _.range(1, 30);
      var data = [];
      var initialAmount = 1000000;
      rangeValues.forEach(() => {
        data.push(initialAmount);
        initialAmount += 500000;
      });

      return data;
    },

    calculateTotalAssets: _.debounce(function() {
      var assets = numeral(this.assets || 0)
        .multiply(10000)
        .value();
      var yearSavingAmount = numeral(this.yearSavingAmount || 0)
        .multiply(10000)
        .value();
      var interest = numeral(this.interest).value();
      var termsOfRetire = numeral(this.termsOfRetire).value();

      var inflation = numeral(this.inflation).value();

      const totalAssets = (
        numeral(assets).value() * Math.pow(1 + interest / 100, termsOfRetire) +
        (yearSavingAmount *
          (Math.pow(1 + interest / 100, termsOfRetire) -
            Math.pow(1 + inflation / 100, termsOfRetire))) /
          ((interest - inflation) / 100)
      ).toFixed(2);

      return totalAssets;
    }, 100),

    calculateParadiseDatas() {
      var rangeValues = _.range(1, 20);
      var data = [];

      var nearTotalAssetGapValue = undefined;
      var nearTotalAssetGapIndex = [];

      var totalAssets = numeral(this.totalAssets).value();
      var actualInterest = this.addNumber(this.interest, -this.inflation);
      var userMonthlySpend = numeral(this.monthlySpend).value();
      this.monthlySpends.forEach((monthlySpend, idx) => {
        var item = {};
        item.monthlySpend = monthlySpend;

        rangeValues.forEach(rangeValue => {
          var colName = `interest${rangeValue}`;
          item[colName] = this.calculateParadiseAmount(
            item.monthlySpend,
            rangeValue,
            this.inflation,
            this.termsOfRetire
          );

          if (totalAssets && rangeValue === actualInterest) {
            var gap = Math.abs(totalAssets - item[colName]);

            if (
              nearTotalAssetGapValue === undefined ||
              gap < nearTotalAssetGapValue
            ) {
              nearTotalAssetGapValue = gap;
              nearTotalAssetGapIndex = [{ index: idx, colName: colName }];
            } else if (gap === nearTotalAssetGapValue) {
              nearTotalAssetGapIndex.push({ index: idx, colName: colName });
            }
          }

          if (
            userMonthlySpend &&
            userMonthlySpend === item.monthlySpend &&
            actualInterest === rangeValue
          ) {
            item[colName + "_color"] = "bg-green-1";
          }
        });

        data.push(item);
      });

      nearTotalAssetGapIndex.forEach(
        near => (data[near.index][near.colName + "_color"] = "bg-cyan-1")
      );

      return data;
    },

    createParadiseColumns() {
      var rangeValues = _.range(1, 20);

      rangeValues.forEach(rangeValue => {
        var name = `interest${rangeValue}`;
        this.paradise_columns.push({
          name: name,
          field: name,
          label: `${rangeValue}%`,
          align: "center",
          format: val => this.format10ThousandUnitNumber(val),
          sortable: false
        });
      });
    },

    calculateParadiseAmount(
      amount = this.monthlySpend,
      interest = parseInt(this.interest || 0) - parseInt(this.inflation || 0),
      inflation = this.inflation,
      terms = this.termsOfRetire
    ) {
      inflation = inflation || 0;
      if (interest <= 0) {
        return undefined;
      }

      var _interest = interest / 100;
      var _inflation = inflation / 100;
      var paradise =
        (amount * 12 * Math.pow(1 + _inflation, terms)) / _interest;
      return paradise;
    },

    calculateParadiseMonthlyIncome(
      totalAsset,
      interest = parseInt(this.interest || 0) - parseInt(this.inflation || 0),
      inflation = this.inflation,
      terms = this.termsOfRetire
    ) {
      if (interest <= 0) {
        return undefined;
      }

      var _interest = interest / 100;
      var _inflation = inflation / 100;
      var paradise =
        ((totalAsset / Math.pow(1 + _inflation, terms)) * _interest) / 12;
      return paradise;
    },

    findNearParadiseValue() {
      const actualInterest = this.addNumber(this.interest, -this.inflation);
      this.foundMonthlySpend = Math.floor(
        this.calculateParadiseMonthlyIncome(this.totalAssets)
      );
      this.foundInterest = actualInterest;

      this.sendGACalculatedMonthlySpend(this.foundMonthlySpend);
    },

    paradiseStateColor() {
      if (isNaN(this.paradiseAmount) || this.paradiseAmount <= 0) {
        return "";
      }

      if (isNaN(this.totalAssets) || this.totalAssets <= 0) {
        return "";
      }

      var stateColors = ["red", "yellow", "green"];
      var rate = (this.paradiseAmount - this.totalAssets) / this.totalAssets;
      if (rate >= 0.5) {
        return stateColors[0];
      } else if (rate > -0.5 && rate < 0.5) {
        return stateColors[1];
      } else {
        return stateColors[2];
      }
    },

    useDefault() {
      this.assets = this.formatNumber(20000);
      this.yearSavingAmount = this.formatNumber(1200);
      this.interest = 10;
      this.inflation = 2;
      this.termsOfRetire = 10;
      this.monthlySpend = 5000000;
    },

    addNumber(value1, value2) {
      return parseInt(value1 || 0) + parseInt(value2 || 0);
    },

    showExample() {
      window.gtag('event', 'popup', {
        event_category: 'ì˜ˆì œ',
        event_label: 'basic'
      });

      this.sample = true;
      this.maximized = this.$q.screen.gt.md ? false : true;
    },
    showSurveyPopupWhenCalculated() {
      if(this.totalAssets && this.foundMonthlySpend && !this.wasShownSurvey) {
        setTimeout(() => {
          this.survey = true;
          this.wasShownSurvey = true;
        }, 1000);
      }
    },
    moveSurvey() {
      this.wasShownSurvey = true;
      window.open("https://docs.google.com/forms/d/e/1FAIpQLScXpdPppmhHJczWZh_nVGnu6GTqGtgrFmpwKRi61uOCWe87xQ/viewform", "popup");
    }
  }
};
</script>
